
version: '3.8'

services:
  # ====================================
  # 主服务：toolkit
  # ====================================
  toolkit:
    container_name: aigc-watermark-toolkit
    image: millionmillionli/aigc-identification-toolkit:latest

    # ====================================
    # GPU支持（NVIDIA Docker）
    # ====================================
    # 重要：需要先安装nvidia-docker2
    # 安装命令：sudo apt-get install -y nvidia-docker2 && sudo systemctl restart docker
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all          # 使用所有可用GPU（单卡或多卡）
              capabilities: [gpu] # 启用GPU计算能力

    # ====================================
    # 环境变量配置
    # ====================================
    environment:
      # ====== Hugging Face模型缓存配置======
      # HF_HOME: Hugging Face总缓存目录
      - HF_HOME=/cache/huggingface

      # HF_HUB_CACHE: Hugging Face Hub模型缓存
      - HF_HUB_CACHE=/cache/huggingface/hub

      # TRANSFORMERS_CACHE: Transformers库专用缓存
      # - 存储transformers.AutoModel加载的模型
      - TRANSFORMERS_CACHE=/cache/huggingface/transformers

      # ====== Bark TTS缓存配置 ======
      - BARK_CACHE_DIR=/cache/bark

      # ====== GPU配置 ======
      - CUDA_VISIBLE_DEVICES=0

      # ====== Python配置 ======
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app

      # ====== 离线模式 ======
      # 如果网络不稳定或没有网络，取消下面两行的注释
      # - TRANSFORMERS_OFFLINE=1
      # - HF_HUB_OFFLINE=1

      # ====== 国内镜像加速 ======
      # 如果在中国大陆，取消下面注释可以加速模型下载
      # - HF_ENDPOINT=https://hf-mirror.com

    # ====================================
    # Volume挂载（核心配置）
    # ====================================
    # 格式：<主机路径>:<容器路径>[:选项]
    # 选项：ro=只读（read-only），rw=读写（默认）
    volumes:
      # ====== 模型缓存目录======
      # 说明：将主机的 Hugging Face 缓存挂载到容器
      # - 主机路径：~/.cache/huggingface（用户的 Hugging Face 缓存目录）
      # - 容器路径：/cache/huggingface
      #   容器内通过 HF_HOME 环境变量访问
      - ~/.cache/huggingface:/cache/huggingface

      # ====== 配置文件（只读挂载）======
      - ./config:/app/config:ro

      # ====== 源代码（开发模式）======
      - ./src:/app/src

      # ====== 测试代码 ======
      - ./tests:/app/tests

      # ====== 输出目录（持久化）======
      - ./outputs:/app/outputs

      # ====== Benchmark数据集======
      - ./benchmarks/Image-Bench/dataset:/app/benchmarks/Image-Bench/dataset:ro
      - ./benchmarks/Video-Bench/dataset:/app/benchmarks/Video-Bench/dataset:ro
      - ./benchmarks/Audio-Bench/dataset:/app/benchmarks/Audio-Bench/dataset:ro
      # ====== Benchmark评估结果======
      # - ./benchmarks/Image-Bench/results:/app/benchmarks/Image-Bench/results
      # - ./benchmarks/Audio-Bench/results:/app/benchmarks/Audio-Bench/results
      # - ./benchmarks/Video-Bench/results:/app/benchmarks/Video-Bench/results

    working_dir: /app

    stdin_open: true
    tty: true

    network_mode: bridge  

    restart: unless-stopped


